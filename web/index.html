<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DMTools</title>

  <script>
    (function() {
      const ua = navigator.userAgent;
      const isSafari = ua.includes('Safari') && !ua.includes('Chrome');
      const isChrome = ua.includes('Chrome');
      const browserName = isSafari ? 'Safari' : (isChrome ? 'Chrome' : 'Browser');
      
      // Enable for both Safari and Chrome for comparison
      if (!isSafari && !isChrome) return;

      console.log(`[${browserName} Perf] ðŸš€ Sampler enabled`);

      // Create visual indicator overlay
      const indicator = document.createElement('div');
      indicator.id = 'perf-indicator';
      const indicatorColor = isSafari ? 'rgba(0, 122, 255, 0.9)' : 'rgba(234, 67, 53, 0.9)';
      indicator.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: ${indicatorColor};
        color: white;
        padding: 10px 14px;
        border-radius: 8px;
        font-family: -apple-system, BlinkMacSystemFont, monospace;
        font-size: 13px;
        font-weight: 600;
        z-index: 999999;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        pointer-events: none;
        line-height: 1.4;
      `;
      const rendererType = window.flutterWebRenderer || 'auto';
      indicator.textContent = `ðŸ“Š ${browserName} (${rendererType}) Measuring...`;
      
      if (document.body) {
        document.body.appendChild(indicator);
      } else {
        window.addEventListener('DOMContentLoaded', () => {
          document.body.appendChild(indicator);
        });
      }

      let rafHandle = null;
      const frameTimes = [];

      function resetSampler() {
        if (rafHandle !== null) {
          cancelAnimationFrame(rafHandle);
          rafHandle = null;
        }
        frameTimes.length = 0;
        indicator.style.display = 'none';
      }

      function updateIndicator() {
        if (frameTimes.length < 2) {
          indicator.textContent = `ðŸ“Š ${browserName} (${rendererType}) - ${frameTimes.length} frames`;
          return;
        }
        const deltas = [];
        for (let i = 1; i < frameTimes.length; i++) {
          deltas.push(frameTimes[i] - frameTimes[i - 1]);
        }
        const avg = deltas.reduce((a, b) => a + b, 0) / deltas.length;
        const worst = Math.max(...deltas);
        
        if (avg > 20) {
          indicator.style.background = 'rgba(200, 0, 0, 0.9)';
        } else if (avg > 16.67) {
          indicator.style.background = 'rgba(255, 165, 0, 0.9)';
        } else {
          indicator.style.background = indicatorColor;
        }
        
        const fps = avg > 0 ? (1000 / avg).toFixed(0) : 'â€”';
        indicator.innerHTML = `ðŸ“Š ${browserName} (${rendererType})<br>FPS: ${fps} | avg ${avg.toFixed(1)}ms<br>worst ${worst.toFixed(1)}ms | ${deltas.length} frames`;
      }

      function logFrameStats(force = false) {
        if (frameTimes.length < 2) {
          if (force && frameTimes.length > 0) {
            console.log(`[${browserName} Perf] only ${frameTimes.length} sample(s); need more scroll to measure.`);
          }
          return;
        }
        const deltas = [];
        for (let i = 1; i < frameTimes.length; i++) {
          deltas.push(frameTimes[i] - frameTimes[i - 1]);
        }
        const avg = deltas.reduce((a, b) => a + b, 0) / deltas.length;
        const worst = Math.max(...deltas);
        const fps = avg > 0 ? (1000 / avg).toFixed(0) : 'â€”';
        console.log(`[${browserName} Perf] ðŸ“Š FPS: ${fps} | avg frame ${avg.toFixed(2)}ms, worst ${worst.toFixed(2)}ms over ${deltas.length} frames`);
      }

      function sampleFrame(ts) {
        frameTimes.push(ts);
        updateIndicator();
        
        if (frameTimes.length > 0 && frameTimes.length % 15 === 0) {
          logFrameStats();
        }
        
        rafHandle = requestAnimationFrame(sampleFrame);
      }

      const debouncedStop = (() => {
        let timeout;
        return () => {
          clearTimeout(timeout);
          timeout = setTimeout(() => {
            logFrameStats(true);
            resetSampler();
            console.log(`[${browserName} Perf] â¹ï¸ Stopped measuring`);
          }, 800);
        };
      })();

      function startMeasuring() {
        if (!rafHandle) {
          console.log(`[${browserName} Perf] ðŸŽ¬ Started measuring`);
          indicator.style.display = 'block';
          indicator.style.background = indicatorColor;
          rafHandle = requestAnimationFrame(sampleFrame);
        }
        debouncedStop();
      }

      window.addEventListener('scroll', startMeasuring, { passive: true });
      window.addEventListener('wheel', startMeasuring, { passive: true });
      window.addEventListener('touchmove', startMeasuring, { passive: true });
      
      const attachToFlutter = () => {
        const glassPane = document.querySelector('flt-glass-pane');
        if (glassPane) {
          console.log(`[${browserName} Perf] ðŸŽ¯ Attached to Flutter glass pane`);
          glassPane.addEventListener('wheel', startMeasuring, { passive: true });
          glassPane.addEventListener('touchmove', startMeasuring, { passive: true });
        }
      };
      
      setTimeout(attachToFlutter, 1000);
      setTimeout(attachToFlutter, 3000);

      console.log(`[${browserName} Perf] ðŸ‘‚ Listening for scroll/wheel/touch events`);
    })();
  </script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
