<!DOCTYPE html>
<html class="theme-dark">
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">
  
  <!-- Cache control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="dmtools_flutter">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>DMTools</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Immediate background script - runs before any other content -->
  <script>
    // Detect theme preference early and set appropriate background
    function setInitialBackground() {
      const savedTheme = localStorage.getItem('flutter.theme_preference');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      // Determine if should use dark theme
      const shouldUseDark = savedTheme === '"ThemePreference.dark"' || 
                           (savedTheme !== '"ThemePreference.light"' && prefersDark);
      
      const bgColor = shouldUseDark ? '#121212' : '#F8F9FA';
      
      // Set background immediately
      document.documentElement.style.backgroundColor = bgColor;
      
      console.log('Initial background set to:', shouldUseDark ? 'dark' : 'light', bgColor);
      
      // Set body background when it's available
      function setBodyBackground() {
        if (document.body) {
          document.body.style.backgroundColor = bgColor;
        } else {
          // Try again in a few milliseconds
          setTimeout(setBodyBackground, 1);
        }
      }
      
      // Start trying to set body background
      setBodyBackground();
      
      // Also listen for DOMContentLoaded as backup
      document.addEventListener('DOMContentLoaded', function() {
        if (document.body) {
          document.body.style.backgroundColor = bgColor;
        }
      });
    }
    
    // Run immediately
    setInitialBackground();
  </script>

  <style>
    /* Aggressively hide all default loading indicators */
    progress,
    .flutter-loader,
    *[class*="loading-bar"],
    *[id*="loading-bar"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    html.theme-dark, 
    html.theme-dark body,
    html.theme-dark flt-glass-pane,
    html.theme-dark flutter-view,
    html.theme-dark #root {
      background-color: #121212 !important;
      color: #E9ECEF !important;
    }
    html.theme-light, 
    html.theme-light body,
    html.theme-light flt-glass-pane,
    html.theme-light flutter-view,
    html.theme-light #root {
      background-color: #F8F9FA !important;
      color: #212529 !important;
    }
    
    html.theme-dark #loading-indicator p {
      color: #CED4DA !important;
    }
    html.theme-light #loading-indicator p {
      color: #495057 !important;
    }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }
    
    /* Ensure all Flutter elements inherit the theme background */
    html.theme-dark *,
    html.theme-dark flt-glass-pane * {
      background-color: inherit !important;
    }
    
    /* Force background on all container elements */
    html.theme-dark div:not(#loading-indicator):not(#loading-indicator *),
    html.theme-dark flt-glass-pane,
    html.theme-dark flutter-view {
      background-color: #121212 !important;
    }
    
    html.theme-light div:not(#loading-indicator):not(#loading-indicator *),
    html.theme-light flt-glass-pane,
    html.theme-light flutter-view {
      background-color: #F8F9FA !important;
    }
    
    /* Theme-specific backgrounds for main containers */
    html.theme-dark,
    html.theme-dark body,
    html.theme-dark #root {
      background-color: #121212 !important;
    }
    
    html.theme-light,
    html.theme-light body,
    html.theme-light #root {
      background-color: #F8F9FA !important;
    }
    
    /* Default background - will be overridden by JavaScript */
    html, body {
      background-color: #F8F9FA; /* Default to light, JS will override */
    }
    
    /* Force background on Flutter canvas elements */
    html.theme-dark canvas:not(#dna-loader),
    html.theme-dark canvas[data-flt-renderer],
    html.theme-dark canvas[data-flt-renderer="html"],
    html.theme-dark canvas[data-flt-renderer="canvaskit"],
    html.theme-dark flt-scene-host,
    html.theme-dark flt-scene,
    html.theme-dark flt-transform-origin {
      background-color: #121212 !important;
    }
    
    html.theme-light canvas:not(#dna-loader),
    html.theme-light canvas[data-flt-renderer],
    html.theme-light canvas[data-flt-renderer="html"],
    html.theme-light canvas[data-flt-renderer="canvaskit"],
    html.theme-light flt-scene-host,
    html.theme-light flt-scene,
    html.theme-light flt-transform-origin {
      background-color: #F8F9FA !important;
    }
    
    /* Restore loading indicator styles */
    #loading-indicator,
    #loading-indicator * {
      background-color: transparent !important;
    }
    #loading-indicator {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #loading-indicator p {
      margin-top: 24px;
      font-family: sans-serif;
      font-size: 16px;
      /* Color will be overridden by theme-specific rules above */
    }
  </style>

  <!-- Theme Detection Script -->
  <script type="text/javascript">
    // Immediately set the theme based on preference or system settings
    (function() {
      try {
        const savedTheme = localStorage.getItem('flutter.theme_preference');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        console.log('Theme detection:', { savedTheme, prefersDark });
        
        if (savedTheme === '"ThemePreference.dark"' || (savedTheme !== '"ThemePreference.light"' && prefersDark)) {
          document.documentElement.className = 'theme-dark';
          console.log('Applied theme-dark class');
          console.log('HTML element classes:', document.documentElement.className);
        } else {
          document.documentElement.className = 'theme-light';
          console.log('Applied theme-light class');
          console.log('HTML element classes:', document.documentElement.className);
        }
      } catch (e) {
        // Fallback to dark theme on error
        console.log('Theme detection error:', e);
        document.documentElement.className = 'theme-dark';
      }
    })();
  </script>

  <!-- OAuth Callback Handler -->
  <script type="text/javascript">
    // Handle OAuth callback parameters
    (function() {
      console.log('OAuth handler running, URL:', window.location.href);
      
      var urlParams = new URLSearchParams(window.location.search);
      var code = urlParams.get('code');
      var state = urlParams.get('state');
      var error = urlParams.get('error');
      
      console.log('OAuth params:', { 
        code: code ? code.substring(0, 10) + '...' : 'missing', 
        state: state ? state.substring(0, 10) + '...' : 'missing',
        error: error || 'none'
      });
      
      if (code && state) {
        // Store OAuth parameters for Flutter to read
        window.oauthParams = {
          code: code,
          state: state,
          error: error
        };
        
        // Set a flag that OAuth parameters are ready
        window.oauthParamsReady = true;
        
        console.log('OAuth params stored in window.oauthParams');
        
        // Clean up URL parameters to avoid showing them in the address bar
        if (window.history && window.history.replaceState) {
          var cleanUrl = window.location.pathname + window.location.hash;
          window.history.replaceState(null, null, cleanUrl);
          console.log('URL cleaned to:', cleanUrl);
        }
      } else {
        console.log('No OAuth parameters found in URL');
      }
    })();
  </script>
</head>
<body>
  <div id="loading-indicator">
    <canvas id="dna-loader" width="300" height="150"></canvas>
    <p>Loading DMTools...</p>
    <script>
      // Check for OffscreenCanvas and Worker support
      if ('OffscreenCanvas' in window && 'Worker' in window) {
        const canvas = document.getElementById('dna-loader');
        // Transfer control to a new worker thread
        const offscreen = canvas.transferControlToOffscreen();
        const worker = new Worker('animation_worker.js');
        // Send the canvas to the worker
        worker.postMessage({ canvas: offscreen }, [offscreen]);
      } else {
        // Fallback for older browsers that don't support OffscreenCanvas
        console.log("Browser does not support OffscreenCanvas. Animation will run on the main thread.");
        // You could potentially load a simpler, CSS-based animation here as a fallback
        const script = document.createElement('script');
        script.src = 'animation_fallback.js'; // A non-worker version of the script
        document.body.appendChild(script);
      }
    </script>
  </div>
  
  <script>
    // Hide loading indicator when Flutter is ready
    window.addEventListener('flutter-first-frame', function() {
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
      
            // Debug theme after Flutter loads - multiple times to catch canvas creation
      const debugTheme = () => {
        console.log('=== FLUTTER THEME DEBUG ===');
        console.log('HTML classes:', document.documentElement.className);
        console.log('Body background:', window.getComputedStyle(document.body).backgroundColor);
        console.log('HTML background:', window.getComputedStyle(document.documentElement).backgroundColor);
        
        // Check for ALL elements, not just canvas
        const flutterElements = document.querySelectorAll('flutter-view, flt-glass-pane, flt-scene-host, flt-scene, flt-transform-origin');
        console.log('Flutter elements found:', flutterElements.length);
        flutterElements.forEach((el, i) => {
          console.log(`Flutter element ${i}:`, el.tagName, 'class:', el.className, 'background:', window.getComputedStyle(el).backgroundColor);
        });
        
        // Check for canvas elements
        const canvases = document.querySelectorAll('canvas');
        console.log('Canvas elements found:', canvases.length);
        canvases.forEach((canvas, i) => {
          const isFlutterCanvas = !canvas.id || canvas.id !== 'dna-loader';
          console.log(`Canvas ${i}:`, isFlutterCanvas ? 'FLUTTER' : 'LOADING', 'id:', canvas.id, 'size:', canvas.width + 'x' + canvas.height);
          console.log(`Canvas ${i} computed bg:`, window.getComputedStyle(canvas).backgroundColor);
          console.log(`Canvas ${i} parent:`, canvas.parentElement?.tagName, canvas.parentElement?.className);
          
          if (isFlutterCanvas) {
            const isDark = document.documentElement.classList.contains('theme-dark');
            const bgColor = isDark ? '#121212' : '#F8F9FA';
            canvas.style.backgroundColor = bgColor + ' !important';
            console.log(`Canvas ${i} FORCED FLUTTER BG to`, bgColor);
          }
        });
        
        // Check for divs that might be Flutter containers
        const divs = document.querySelectorAll('div');
        console.log('Total divs found:', divs.length);
        let suspiciousDivs = 0;
        divs.forEach(div => {
          const bg = window.getComputedStyle(div).backgroundColor;
          if ((bg.includes('255, 255, 255') || bg === 'white' || bg === 'rgb(255, 255, 255)') && 
              div.id !== 'loading-indicator' && !div.closest('#loading-indicator')) {
            suspiciousDivs++;
            if (suspiciousDivs <= 5) { // Log first 5 suspicious divs
              console.log(`Suspicious white div ${suspiciousDivs}:`, div, 'class:', div.className, 'id:', div.id, 'background:', bg);
              // Force correct background
              const isDark = document.documentElement.classList.contains('theme-dark');
              const bgColor = isDark ? '#121212' : '#F8F9FA';
              div.style.backgroundColor = bgColor;
              console.log(`Fixed div background to:`, bgColor);
            }
          }
        });
        console.log('Suspicious white divs:', suspiciousDivs);
        
        // Check if there are any elements with white background
        const allElements = document.querySelectorAll('*');
        let whiteElements = 0;
        allElements.forEach(el => {
          const bg = window.getComputedStyle(el).backgroundColor;
          if (bg.includes('255, 255, 255') || bg === 'white' || bg === 'rgb(255, 255, 255)') {
            whiteElements++;
          }
        });
        console.log('Total white elements:', whiteElements);
      };
      
      // Run debug to verify theme is applied
      setTimeout(debugTheme, 1000);
      
      // Simplified periodic check - only run a few times to catch late Flutter elements
      let checkCount = 0;
      const periodicCheck = setInterval(() => {
        checkCount++;
        console.log(`🔍 Periodic check ${checkCount}/10`);
        
        // Stop after 1 second (10 checks at 100ms intervals)
        if (checkCount >= 10) {
          clearInterval(periodicCheck);
          console.log('🏁 Periodic theme checks completed');
        }
      }, 100);
      
      // Also set up a MutationObserver to detect new canvas elements
      const observer = new MutationObserver((mutations) => {
        const isDark = document.documentElement.classList.contains('theme-dark');
        const bgColor = isDark ? '#121212' : '#F8F9FA';
        
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            // Check if this is a canvas element
            if (node.tagName === 'CANVAS' && node.id !== 'dna-loader') {
              console.log('🎯 NEW FLUTTER CANVAS DETECTED!', node);
              node.style.backgroundColor = bgColor + ' !important';
              console.log('🎯 FORCED NEW CANVAS BACKGROUND TO', bgColor);
            }
            
            // Check if this is a Flutter element
            if (node.tagName && ['FLT-GLASS-PANE', 'FLUTTER-VIEW', 'FLT-SCENE-HOST', 'FLT-SCENE', 'FLT-TRANSFORM-ORIGIN'].includes(node.tagName)) {
              console.log('🎯 NEW FLUTTER ELEMENT DETECTED!', node.tagName);
              node.style.backgroundColor = bgColor + ' !important';
              console.log('🎯 FORCED FLUTTER ELEMENT BACKGROUND TO', bgColor);
            }
            
            // Check if this is a div that might be a Flutter container
            if (node.tagName === 'DIV' && node.id !== 'loading-indicator' && !node.closest('#loading-indicator')) {
              const computedBg = window.getComputedStyle(node).backgroundColor;
              if (computedBg.includes('255, 255, 255') || computedBg === 'white' || computedBg === 'rgb(255, 255, 255)') {
                console.log('🎯 NEW WHITE DIV DETECTED!', node, 'class:', node.className, 'id:', node.id);
                node.style.backgroundColor = bgColor + ' !important';
                console.log('🎯 FORCED DIV BACKGROUND TO', bgColor);
              }
            }
            
            // Also check child nodes for canvas and Flutter elements
            if (node.querySelectorAll) {
              const canvases = node.querySelectorAll('canvas:not(#dna-loader)');
              canvases.forEach(canvas => {
                console.log('🎯 NEW FLUTTER CANVAS IN CHILD!', canvas);
                canvas.style.backgroundColor = bgColor + ' !important';
                console.log('🎯 FORCED CHILD CANVAS BACKGROUND TO', bgColor);
              });
              
              const flutterElements = node.querySelectorAll('flt-glass-pane, flutter-view, flt-scene-host, flt-scene, flt-transform-origin');
              flutterElements.forEach(el => {
                console.log('🎯 NEW FLUTTER ELEMENT IN CHILD!', el.tagName);
                el.style.backgroundColor = bgColor + ' !important';
                console.log('🎯 FORCED CHILD FLUTTER ELEMENT BACKGROUND TO', bgColor);
              });
              
              // Check for white divs in children
              const whiteDivs = node.querySelectorAll('div');
              whiteDivs.forEach(div => {
                if (div.id !== 'loading-indicator' && !div.closest('#loading-indicator')) {
                  const computedBg = window.getComputedStyle(div).backgroundColor;
                  if (computedBg.includes('255, 255, 255') || computedBg === 'white' || computedBg === 'rgb(255, 255, 255)') {
                    console.log('🎯 NEW WHITE CHILD DIV!', div, 'class:', div.className, 'id:', div.id);
                    div.style.backgroundColor = bgColor + ' !important';
                    console.log('🎯 FORCED CHILD DIV BACKGROUND TO', bgColor);
                  }
                }
              });
            }
          });
        });
      });
      
      // Start observing
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
      
      // Listen for Flutter theme changes and sync to HTML
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'flutter-theme-change') {
          console.log('🎨 Flutter theme change detected:', event.data.theme);
          const isDark = event.data.theme === 'dark';
          const bgColor = isDark ? '#121212' : '#F8F9FA';
          
          // Update HTML class
          document.documentElement.className = isDark ? 'theme-dark' : 'theme-light';
          
          // Update main container backgrounds
          document.body.style.backgroundColor = bgColor;
          document.documentElement.style.backgroundColor = bgColor;
          
          // Force background on all existing canvases
          const canvases = document.querySelectorAll('canvas:not(#dna-loader)');
          canvases.forEach(canvas => {
            canvas.style.backgroundColor = bgColor + ' !important';
            console.log('🎨 Updated canvas background for theme change');
          });
          
          // Force background on all Flutter elements
          const flutterElements = document.querySelectorAll('flt-glass-pane, flutter-view, flt-scene-host, flt-scene');
          flutterElements.forEach(el => {
            el.style.backgroundColor = bgColor + ' !important';
            console.log('🎨 Updated Flutter element background');
          });
          
          console.log('🎨 Applied aggressive theme sync:', isDark ? 'dark' : 'light');
        }
      });
      
      // Also listen for storage changes (theme preference updates)
      window.addEventListener('storage', function(event) {
        if (event.key === 'flutter.theme_preference') {
          console.log('🎨 Theme preference changed in storage:', event.newValue);
          const isDark = event.newValue === '"ThemePreference.dark"';
          document.documentElement.className = isDark ? 'theme-dark' : 'theme-light';
          
          // Force background on all existing canvases
          const canvases = document.querySelectorAll('canvas:not(#dna-loader)');
          canvases.forEach(canvas => {
            canvas.style.backgroundColor = isDark ? '#121212' : '#F8F9FA';
            console.log('🎨 Updated canvas background for storage change');
          });
        }
      });
    });
  </script>
  
  <script src="flutter_bootstrap.js?v=1.1" async></script>
</body>
</html>
