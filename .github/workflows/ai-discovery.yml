name: AI Code Discovery

on:
  workflow_dispatch:
    inputs:
      user_request:
        description: 'Your discovery request for AI analysis'
        required: true
        type: string
      model:
        description: 'Gemini model to use for discovery'
        required: false
        type: choice
        default: 'gemini-2.5-flash-preview-05-20'
        options:
          - gemini-2.0-flash-exp
          - gemini-1.5-pro-latest
          - gemini-1.5-flash-latest
          - gemini-1.0-pro-latest
          - gemini-2.5-flash-preview-05-20
          - gemini-2.5-pro-latest
      enable_debug_logging:
        description: 'Enable comprehensive debug logging for AI discovery'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  issues: write

jobs:
  ai-discovery:
    name: AI Code Discovery
    uses: IstiN/dmtools-agentic-workflows/.github/workflows/reusable-gemini-discovery.yml@main
    with:
      user_request: ${{ inputs.user_request }}
      model: ${{ inputs.model }}
      enable_debug_logging: ${{ inputs.enable_debug_logging }}
      
      # Flutter-specific customizations
      custom_discovery_prompt: '.github/ai-prompts/flutter-discovery-prompt.md'
      custom_rules_file: '@commonrules.mdc'
      additional_context_files: >-
        README.md,
        pubspec.yaml,
        analysis_options.yaml,
        flutter_styleguide/README.md,
        flutter_styleguide/pubspec.yaml,
        lib/main.dart,
        lib/service_locator.dart,
        docs/shared-css-architecture.md,
        docs/shared-assets-implementation.md
      
      # Use specific version for stability
      workflows_repo: 'IstiN/dmtools-agentic-workflows'
      workflows_ref: 'main'
      
    secrets:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

  display-flutter-discovery-summary:
    name: Flutter Discovery Summary
    needs: ai-discovery
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download discovery artifacts
      uses: actions/download-artifact@v4
      with:
        name: agentic-discovery-results-${{ github.run_number }}
        path: outputs/
        
    - name: Display Flutter discovery summary
      run: |
        # Display comprehensive summary like original workflow
        echo "## 🔍 Flutter Discovery Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show request details
        echo "### 📋 Request Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Project Type**: Flutter Web & Mobile Application" >> $GITHUB_STEP_SUMMARY
        echo "- **Model**: ${{ inputs.model }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug Logging**: ${{ inputs.enable_debug_logging }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show original request
        echo "### 📝 Original Request" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat outputs/user-request.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show discovery results from response.md
        echo "### 🔍 Discovery Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "outputs/response.md" ]; then
          cat outputs/response.md >> $GITHUB_STEP_SUMMARY
        elif [ -f "outputs/discovery-summary/discovery-analysis.md" ]; then
          cat outputs/discovery-summary/discovery-analysis.md >> $GITHUB_STEP_SUMMARY
        else
          echo "Discovery completed but response file not found." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Flutter discovery results and logs have been uploaded as workflow artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact Name**: flutter-discovery-results-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Retention**: 14 days" >> $GITHUB_STEP_SUMMARY
        echo "- **Contents**: Discovery analysis, logs, and full report" >> $GITHUB_STEP_SUMMARY
        
    - name: Upload Flutter discovery artifacts
      uses: actions/upload-artifact@v4
      with:
        name: flutter-discovery-results-${{ github.run_number }}
        path: |
          outputs/response.md
          outputs/response-log_*.txt
          outputs/discovery-prompt-combined.md
          outputs/user-request.txt
          outputs/gemini-discovery.log
          outputs/discovery-summary/
        retention-days: 14
        if-no-files-found: warn

