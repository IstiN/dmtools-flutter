name: Release Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.7.87)'
        required: true
        default: 'v1.7.87'
      server_version:
        description: 'DMTools server version (e.g., v1.7.78)'
        required: true
        default: 'v1.7.78'
      platforms:
        description: 'Platforms to build (comma-separated: macos,windows or all)'
        required: true
        default: 'all'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      server_version: ${{ steps.version.outputs.SERVER_VERSION }}
      build_macos: ${{ steps.platforms.outputs.BUILD_MACOS }}
      build_windows: ${{ steps.platforms.outputs.BUILD_WINDOWS }}
    
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "SERVER_VERSION=${{ github.event.inputs.server_version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "SERVER_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Determine platforms
        id: platforms
        run: |
          PLATFORMS="${{ github.event.inputs.platforms }}"
          
          # Default to all if not specified
          if [ -z "$PLATFORMS" ] || [ "$PLATFORMS" == "all" ]; then
            echo "BUILD_MACOS=true" >> $GITHUB_OUTPUT
            echo "BUILD_WINDOWS=true" >> $GITHUB_OUTPUT
          else
            if echo "$PLATFORMS" | grep -q "macos"; then
              echo "BUILD_MACOS=true" >> $GITHUB_OUTPUT
            else
              echo "BUILD_MACOS=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$PLATFORMS" | grep -q "windows"; then
              echo "BUILD_WINDOWS=true" >> $GITHUB_OUTPUT
            else
              echo "BUILD_WINDOWS=false" >> $GITHUB_OUTPUT
            fi
          fi

  build-macos:
    needs: prepare
    if: needs.prepare.outputs.build_macos == 'true'
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Download DMTools server bundle
        run: |
          echo "Downloading DMTools server ${{ needs.prepare.outputs.server_version }}"
          
          curl -L -o dmtools-standalone-macos-aarch64.zip \
            "https://github.com/IstiN/dmtools-server/releases/download/${{ needs.prepare.outputs.server_version }}/dmtools-standalone-macos-aarch64-${{ needs.prepare.outputs.server_version }}.zip"
          
          if [ ! -f dmtools-standalone-macos-aarch64.zip ]; then
            echo "❌ Failed to download server bundle"
            exit 1
          fi
      
      - name: Build Flutter app for macOS
        run: flutter build macos --release
      
      - name: Package macOS application
        run: |
          chmod +x scripts/pack-macos.sh
          mkdir -p dist
          
          ./scripts/pack-macos.sh \
            build/macos/Build/Products/Release/dmtools.app \
            dmtools-standalone-macos-aarch64.zip \
            dist \
            ${{ needs.prepare.outputs.version }}
      
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dmtools-macos-${{ needs.prepare.outputs.version }}
          path: dist/*.dmg
          retention-days: 7

  build-windows:
    needs: prepare
    if: needs.prepare.outputs.build_windows == 'true'
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Download DMTools server bundle
        shell: bash
        run: |
          echo "Downloading DMTools server ${{ needs.prepare.outputs.server_version }}"
          
          curl -L -o dmtools-standalone-windows-x64.zip \
            "https://github.com/IstiN/dmtools-server/releases/download/${{ needs.prepare.outputs.server_version }}/dmtools-standalone-windows-x64-${{ needs.prepare.outputs.server_version }}.zip"
          
          if [ ! -f dmtools-standalone-windows-x64.zip ]; then
            echo "❌ Failed to download server bundle"
            exit 1
          fi
      
      - name: Build Flutter app for Windows
        run: flutter build windows --release
      
      - name: Package Windows application
        shell: bash
        run: |
          chmod +x scripts/pack-windows.sh
          mkdir -p dist
          
          ./scripts/pack-windows.sh \
            build/windows/x64/runner/Release \
            dmtools-standalone-windows-x64.zip \
            dist \
            ${{ needs.prepare.outputs.version }}
      
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dmtools-windows-${{ needs.prepare.outputs.version }}
          path: dist/*.zip
          retention-days: 7

  create-release-summary:
    needs: [prepare, build-macos, build-windows]
    if: always() && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    
    steps:
      - name: Create release summary
        run: |
          echo "# DMTools Release ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: ${{ needs.build-macos.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Windows: ${{ needs.build-windows.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Server Version" >> $GITHUB_STEP_SUMMARY
          echo "Using DMTools Server: ${{ needs.prepare.outputs.server_version }}" >> $GITHUB_STEP_SUMMARY

